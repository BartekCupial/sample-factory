
Bootstrap: docker
# From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04
# From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04
From: rocm/pytorch:rocm6.2_ubuntu22.04_py3.10_pytorch_release_2.3.0

%environment
    export DEBIAN_FRONTEND=noninteractive
    python --version
%setup
    mkdir -p ${SINGULARITY_ROOTFS}/dungeons
    # cp -r . ${SINGULARITY_ROOTFS}/dungeons
    # when using --sandbox mode there is a problem with copying the entire directory
    # When Singularity tries to copy the directory into the sandbox,
    # it is actually copying the sandbox into itself, which is not allowed.
    rsync -av --exclude=".singularity" . ${SINGULARITY_ROOTFS}/dungeons

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -yq \
        build-essential \
        cmake \
        curl \
        git \
        ninja-build \
        wget \
        make \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev

    # nle dependencies
    apt-get install -yq autoconf libtool pkg-config libbz2-dev

    mkdir conda_setup
    cd conda_setup
    curl -o miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
        chmod +x miniconda.sh && \
        ./miniconda.sh -b -p /opt/conda -u && \
        /opt/conda/bin/conda install -y python=3.10 && \
        /opt/conda/bin/conda clean -ya

%environment
    export PATH="/opt/conda/bin:$PATH"
    echo "orig"
    python --version
    echo "conda"
    /opt/conda/bin/python --version
%post
    export PATH="/opt/conda/bin:$PATH"

    python -m pip install --upgrade pip
    pip install --upgrade setuptools
 
    conda update -n base -c defaults conda
    conda install -yq cmake flex bison lit
    conda install -yq pybind11 -c conda-forge
    conda install -yq pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia

    # install sample factory
    cd /dungeons/
    echo "dungeons"
    python --version
    /opt/conda/bin/python --version
    pip install .[dev,atari,mrunner]

    pip install h5py

    chmod a+rw -R /opt/conda/bin/python

    apt-get clean
    rm -rf /var/lib/apt/lists/*

    conda clean --all
    conda info

%runscript
    exec "$@"
